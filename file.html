const fs = require('hexo-fs');

hexo.on('generateBefore', function(){
  const locals = hexo.locals.toObject();
  const tagMap = hexo.config.tag_map;
  const initTags = locals.tags.data;
  const names = [];

  Object.keys(initTags).forEach(item => {
    const tag = initTags[item];
    names.push(tag.name);
  });

  names.forEach(name => {
    if (!tagMap[name]) {
      tagMap[name] = name.toLocaleLowerCase();
    }
  });

  fs.writeFile(hexo.config_path, genData(tagMap), { flag: 'a' });
});

function genData(tagMap) {
  let str = '\n\ntag_map:\n';

  Object.keys(tagMap).forEach(item => {
    str += '  ' + item + ': ' + tagMap[item] + '\n';
  });

  return str;
}
