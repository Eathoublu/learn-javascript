/* global hexo */
const fs = require('hexo-fs');

// Generate tag map data
function genData(tagMap) {
  let str = 'tag_map:\n';

  Object.keys(tagMap).forEach((item) => {
    str += `  ${item}: ${tagMap[item]}\n`;
  });

  return str;
}

hexo.load().then(() => {
  const locals = hexo.locals.toObject();
  const tagMap = hexo.config.tag_map || {};
  const reg = JSON.stringify(tagMap) === '{}' ? /tag_map:\n/ : /tag_map:\n(\s{2}.*\n)+/;
  const initTags = locals.tags.data;

  if (Object.keys(tagMap).length !== Object.keys(initTags).length) {
    const names = [];

    Object.keys(initTags).forEach((item) => {
      const tag = initTags[item];
      names.push(tag.name);
    });

    names.forEach((name) => {
      if (!tagMap[name]) {
        tagMap[name] = name.toLocaleLowerCase();
      }
    });

    fs.readFile(hexo.config_path, (err, data) => {
      if (err) {
        throw err;
      }

      const newData = data.replace(reg, genData(tagMap));
      fs.writeFile(hexo.config_path, newData);
    });
  }
});

// module.exports = genData;

// eslintrc
{q
    "eslint-plugin-import": "^2.8.0",
    "mocha": "^4.0.1"
  },
  "dependencies": {
    "hexo-fs": "^0.2.2"
  }
}

// test/index.js
const genData = require('../index.js');
const expect = require('chai').expect;

describe('GenData Test', function() {
  it('GenData should generate the tag map in correct format.', () => {
    const testMap = { Test: 'test' };
    expect(genData(testMap)).to.be.equal('tag_map:\n  Test: test\n');
  })
});

在公交车线路改变后，我终于开始尝试着步行下班了。好处是能锻炼身体，坏处就是成为了大自然的“吸尘器”。但是，锻炼身体必须要坚持下来，走路就是一个很好的开始。
——2017/12/27 16:11

明天就是元旦了，新的一年，新的开始。朋友圈里都在晒十八岁的照片，我的十八岁呢？早已经远去。现在的我已经是一个大人了，不会再像小孩子一样，遇事只能无助地哭泣。不说硬话，不做软事，新的一年，找到真正的自己。
——2017/12/31 23：17

新年来第一天上班，倒霉透顶。早上起迟了，急忙坐上公交车。司机师傅开车非常猛，我闭着眼睛在座位上打瞌睡，心中暗喜，觉得车速这么快，肯定不会迟到。结果路上就撞到一辆货车，被赶下公交车后。打了个黑车，钱花了最后还是迟到，真是无语。

——2018/1/2 17:22

