const fs = require('hexo-fs');

hexo.load().then(function(){
  const locals = hexo.locals.toObject();
  const tagMap = hexo.config.tag_map;
  const initTags = locals.tags.data;
  const names = [];

  Object.keys(initTags).forEach(item => {
    const tag = initTags[item];
    names.push(tag.name);
  });

  names.forEach(name => {
    if (!tagMap[name]) {
      tagMap[name] = name.toLocaleLowerCase();
    }
  });

  fs.readFile(hexo.config_path, function(err, data) {
    if (err) {
        throw err;
    }

    const newData = data.replace(/tag_map:\n(\s{2}.*\n)+/, genData(tagMap));
    fs.writeFile(hexo.config_path, newData);
  });
});

function genData(tagMap) {
  let str = 'tag_map:\n';

  Object.keys(tagMap).forEach(item => {
    str += '  ' + item + ': ' + tagMap[item] + '\n';
  });

  return str;
}
