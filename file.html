# coding=utf-8
import MySQLdb
import time

# connect database
conn= MySQLdb.connect(
        host='localhost',
        port = 3306,
        user='root',
        passwd='root',
        db ='typecho',
        charset='utf8',
        use_unicode=True
        )
cur = conn.cursor()
datas = cur.execute("select * from typecho_contents where type = 'post'")
info = cur.fetchmany(datas)

# output data to files
for data in info:
  with open('posts/' + data[2] + '.md', 'w') as f:
    f.write('---\n')
    # title
    f.write('title: ' + data[1].encode('utf8') + '\n')
    # date
    curtime = data[3];
    date = time.strftime('%Y-%m-%d %H:%M', time.localtime(curtime))
    f.write('date: %s\n' % date)

    # tags
    tag_str = '';
    tags = cur.execute("select mid from typecho_relationships where cid = %d" % data[0])
    tags = cur.fetchmany(tags)
    for tag in tags:
      meta = cur.execute("select name from typecho_metas where mid = %d and type = 'tag'" % tag)
      names = cur.fetchmany(meta)
      for name in names:
        tag_str += name[0].encode('utf8') + ', '

    if len(tag_str) > 0:
      tag_str = '[' + tag_str[:-2] + ']'
      f.write('tags: %s\n' % tag_str)
    f.write('---\n')

    # article
    article = data[5].encode('utf8');
    article = article.replace('\n', '')
    # delete the flag of markdown: <!--markdown-->
    article = article[15:]
    f.write(article + '\n')

cur.close()
conn.commit()
conn.close()
